import{a as Pe,b as $e}from"./chunk-L2OPFK6C.js";import{a as be,b as ye}from"./chunk-MHFWVNA3.js";import{a as ke}from"./chunk-RZSF57HL.js";import{a as Ae}from"./chunk-HF7AJZBN.js";import{a as Le}from"./chunk-FDUHK4JZ.js";import{a as Ve}from"./chunk-4I6XGE32.js";import"./chunk-BPKE73F5.js";import{c as ze}from"./chunk-WNFWZ555.js";import{a as Fe}from"./chunk-I6674MYI.js";import{a as Ie}from"./chunk-BKXHZXME.js";import{b as xe}from"./chunk-LQAATZVK.js";import"./chunk-6PBUM7O4.js";import"./chunk-FWDT53KA.js";import{a as Me}from"./chunk-NKAZ3M43.js";import"./chunk-NBFOU5XV.js";import"./chunk-BRZEPVZT.js";import{a as Re}from"./chunk-6BC4QFZY.js";import{b as Te,c as Ee}from"./chunk-46G4OXLF.js";import{D as Se}from"./chunk-RCUMT5X2.js";import{c as _e,d as Ce,f as I,g as M,i as we}from"./chunk-OK5S6IU3.js";import{b as L}from"./chunk-LIFXJ7WC.js";import{b as fe}from"./chunk-CKKTX6AT.js";import"./chunk-MOL5OWPJ.js";import{Ab as y,B as z,Dc as le,Ea as u,Fa as h,Fb as ne,Fc as q,Ga as F,Gc as ce,Ha as j,Hc as Q,Ia as te,Ic as Y,Jc as pe,Ka as ie,Kb as R,Kc as de,M as J,N as H,Ob as l,P as K,Rb as re,Sb as oe,T as O,Tb as v,Ub as ae,V as X,Wb as B,X as D,Xb as U,Yb as a,Yc as me,Zb as s,_b as c,_c as ge,cc as V,ea as w,f as De,fa as E,fc as f,ha as x,hc as m,i as Z,ib as N,jb as _,ld as ue,ob as r,od as he,q as P,qa as S,rd as ve,s as $,sc as T,tc as se,ua as ee,uc as W,vc as p,w as k,wc as C,xc as b,zb as A}from"./chunk-UVO63754.js";var He={PRIMARY:"#6e1029",ACCENT:"#324e85",SECONDARY:"#a98a6c",TERTIARY:"#404041"};var g=De(Fe());var je=["baseElement"],Ne=["waves"],Be=["video"],Ue=["idleVideo"],We=["container"],qe=(i,n)=>n.id,Qe=i=>({"-start-10 opacity-100":i}),Oe=(i,n,t)=>({"bg-red-600":i,"bg-green-700":n,"bg-orange-500":t}),Ye=i=>({hidden:i}),Ge=(i,n)=>({"mdi-chevron-down":i,"mdi-chevron-up":n});function Ze(i,n){if(i&1&&(a(0,"span",8),p(1),s()),i&2){let t=m();r(),C(t.recognizedText())}}function Je(i,n){if(i&1&&c(0,"app-spinner-loader",11),i&2){let t=m();l("color",t.appColors.PRIMARY)("borderWidth",2)("width",20)}}function Ke(i,n){if(i&1&&(c(0,"img",21),p(1)),i&2){let t=m();l("src",t.store.isStreamStarted()?"assets/icons/stop.png":"assets/icons/start.png",_),r(),b(" ",t.store.isStreamStarted()?t.lang.locals.stop:t.lang.locals.start," ")}}function Xe(i,n){if(i&1&&(c(0,"app-spinner-loader",11),a(1,"span"),p(2),s()),i&2){let t=m();l("color",t.appColors.PRIMARY)("borderWidth",2)("width",20),r(2),C(t.lang.locals.loading)}}function et(i,n){if(i&1&&(c(0,"img",21),a(1,"span"),p(2),s()),i&2){let t=m();l("src","assets/icons/speak.png",_),r(2),C(t.lang.locals.click_to_speak)}}function tt(i,n){if(i&1&&(c(0,"img",21),a(1,"span"),p(2),s()),i&2){let t=m();l("src","assets/icons/speak.png",_),r(2),C(t.lang.locals.listening_ongoing)}}function it(i,n){if(i&1&&(c(0,"div",38),Y(1,"sanitizer"),a(2,"span"),p(3),s()),i&2){let t=m();l("innerHTML",de(1,2,t.svgIcons.SEND,"html"),N),r(3),C(t.lang.locals.click_to_send)}}function nt(i,n){if(i&1){let t=V();a(0,"div",41),f("animating",function(o){u(t);let d=m(2);return h(d.animationStatus.set(o))}),s()}if(i&2){let t=m().$implicit;l("text",t.content)}}function rt(i,n){if(i&1&&c(0,"div",40),i&2){let t=m().$implicit;l("innerHtml",t.content,N)}}function ot(i,n){if(i&1&&(a(0,"div",46)(1,"div",47)(2,"small",48),p(3),c(4,"i",49),s()(),a(5,"a",50),p(6),s()()),i&2){let t=n.$implicit,e=n.$index;r(3),b(" doc ",e+1," "),r(3),C(t.filepath)}}function at(i,n){if(i&1){let t=V();a(0,"div")(1,"div",42),f("click",function(){u(t);let o=W(6);return h(o.hidden=!o.hidden)}),c(2,"i",43),a(3,"span",44),p(4,"References"),s()(),a(5,"div",45,5),B(7,ot,7,2,"div",46,ae),s()()}if(i&2){let t=W(6),e=m().$implicit;r(2),l("ngClass",ce(1,Ge,t.hidden,!t.hidden)),r(5),U(e.context.citations)}}function st(i,n){if(i&1&&(a(0,"div"),R(1,nt,1,1,"div",39)(2,rt,1,1,"div",40)(3,at,9,4,"div"),s()),i&2){let t=n.$implicit;oe("message ",t.role,""),r(),v(t.role==="assistant"?1:2),r(2),v(t.context&&t.context.citations.length?3:-1)}}var G=class i extends Re(class{}){baseElement=y.required("baseElement");waves=y.required("waves");video=y.required("video");idleVideo=y("idleVideo");chatContainer=y.required("container");avatarService=S(ze);lang=S(fe);store=S(xe);chatService=S(Ae);chatHistoryService=S(Me);speechService=S(Ie);injector=S(ie);svgIcons=be;start$=new $(1);stop$=new $(1);recognizedText=A("");recognizingText=A("");recognized$=new P;accept$=new P;recognizingStatus=A(!1);botNames$=this.chatHistoryService.getAllBotNames().pipe(x(n=>this.chatService.botNameCtrl.patchValue(n.at(0))));animationStatus=A(!1);appColors=He;init$=this.start$.asObservable().pipe(x(()=>this.store.updateStreamStatus("InProgress"))).pipe(E(this.destroy$)).pipe(D(()=>this.avatarService.startStream("life-size").pipe(K(n=>{throw this.store.updateStreamStatus("Stopped"),n})).pipe(L()))).pipe(w(n=>{let{data:{webrtcData:{offer:t,iceServers:e}}}=n;return this.pc=new RTCPeerConnection({iceServers:e,iceTransportPolicy:"relay"}),this.pc.addEventListener("icecandidate",o=>{o.candidate&&this.avatarService.sendCandidate(o.candidate).subscribe()}),this.pc.addEventListener("icegatheringstatechange",o=>{o.target.iceGatheringState=="complete"&&this.video().nativeElement.paused&&(this.video().nativeElement.play().then(),this.store.updateStreamStatus("Started"))}),this.pc.addEventListener("track",o=>{this.video().nativeElement.srcObject=o.streams[0]}),this.pc.addEventListener("connectionstatechange",o=>{let d=o.target.connectionState;d==="connected"&&this.store.updateStreamStatus("Started"),d==="disconnected"&&this.store.updateStreamStatus("Stopped")}),k(this.pc.setRemoteDescription(new RTCSessionDescription(t))).pipe(w(()=>k(this.pc.createAnswer()))).pipe(w(o=>k(this.pc.setLocalDescription(o)).pipe(z(()=>o)))).pipe(w(o=>this.avatarService.sendAnswer(o)))})).pipe(z(()=>""));onlineStatus=me(()=>{switch(this.lang.localChange(),this.store.streamingStatus()){case"Started":return this.lang.locals.connected;case"InProgress":return this.lang.locals.connecting;case"Disconnecting":return this.lang.locals.disconnecting;default:return this.lang.locals.not_connected}});ngOnInit(){return Z(this,null,function*(){this.store.updateStreamStatus("Stopped"),J(this.destroy$).pipe(x(()=>this.store.updateStreamStatus("Stopped"))).pipe(w(()=>this.avatarService.closeStream().pipe(L()))).subscribe(()=>{console.log("COMPONENT DESTROYED")}),this.stop$.pipe(H(()=>this.store.hasStream())).pipe(x(()=>this.store.updateStreamStatus("Disconnecting"))).pipe(E(this.destroy$)).pipe(w(()=>this.avatarService.closeStream().pipe(L()))).subscribe(()=>{this.store.updateStreamStatus("Stopped"),console.log("MANUAL CLOSE"),this.store.updateStreamStatus("Stopped")}),this.start$.next(),this.listenToAccept(),this.listenToBotNameChange(),this.prepareRecorder()})}ngAfterViewInit(){this.playIdle()}toggleStream(){this.store.isStreamLoading()||(this.store.isStreamStopped()?this.start$.next():this.stop$.next())}interruptAvatar(){this.avatarService.interruptAvatar().pipe(O(1)).subscribe()}clearChat(){this.chatService.messages.set([])}startRecording(){this.store.recordingInProgress(),this.recognizer.startContinuousRecognitionAsync(()=>{this.recognizer.internalData.privConnectionPromise.__zone_symbol__state===!0&&this.store.recordingStarted(),this.recognizingStatus.set(!0)})}stopRecording(){this.recognizer.stopContinuousRecognitionAsync(()=>{this.store.recordingStopped()})}toggleRecording(){this.store.isRecordingLoading()||(this.store.isRecordingStarted()?this.acceptText():this.startRecording())}acceptText(){this.accept$.next()}rejectText(){this.recognizingText.set(""),this.recognizedText.set(""),this.recognizingStatus.set(!1),this.stopRecording()}goToEndOfChat(){setTimeout(()=>{let n=this.chatContainer().nativeElement.querySelectorAll(".user");n[n.length-1].scrollIntoView({behavior:"smooth"})},100)}prepareRecorder(){this.waveSurfer=new Pe({waveColor:"white",progressColor:"white",container:this.waves().nativeElement,height:"auto"}),this.recorder=this.waveSurfer.registerPlugin($e.create({scrollingWaveform:!1})),navigator.mediaDevices.getUserMedia({audio:!0,video:!1}).then(e=>this.recorder.renderMicStream(e));let n=g.AudioConfig.fromDefaultMicrophoneInput(),t=g.AutoDetectSourceLanguageConfig.fromLanguages(["ar-QA","en-US"]);this.recognizer=g.SpeechRecognizer.FromConfig(g.SpeechConfig.fromAuthorizationToken(this.store.speechToken.token(),this.store.speechToken.region()),t,n),this.recognizer.recognizing=(e,o)=>{o.result.reason===g.ResultReason.RecognizingSpeech&&(this.recognizingText.set(this.recognizedText()+" "+o.result.text),this.recognizingStatus.set(!0))},this.recognizer.recognized=(e,o)=>{o.result.reason===g.ResultReason.RecognizedSpeech&&this.store.isRecordingStarted()&&(this.recognizedText.update(d=>d+" "+o.result.text),this.recognized$.next(),this.recognizingStatus.set(!1))},this.recognizer.canceled=()=>{this.store.recordingInProgress(),this.speechService.generateSpeechToken().pipe(O(1)).subscribe(()=>{this.prepareRecorder(),this.startRecording()})}}listenToAccept(){this.accept$.pipe(z(()=>this.recognizedText())).pipe(H(n=>!!n)).pipe(E(this.destroy$)).pipe(x(()=>{this.recognizedText.set(""),this.recognizingText.set(""),this.recognizingStatus.set(!1),this.stopRecording()})).pipe(x(()=>this.goToEndOfChat())).pipe(D(n=>this.chatService.sendMessage(n,this.chatService.botNameCtrl.value))).pipe(X(200)).subscribe(()=>{let n=this.chatContainer().nativeElement.querySelectorAll(".assistant"),t=ge(()=>{this.animationStatus()||(n[n.length-1].scrollIntoView({behavior:"smooth"}),t.destroy())},{injector:this.injector})})}listenToBotNameChange(){this.chatService.onBotNameChange().pipe(E(this.destroy$)).subscribe()}toggleFullScreen(){document.fullscreenElement?document.exitFullscreen().then():this.baseElement().nativeElement.requestFullscreen().then()}isFullScreen(){return!!document.fullscreenElement}playIdle(){this.idleVideo()&&this.idleVideo()?.nativeElement&&(this.idleVideo().nativeElement.src=this.store.idleAvatarUrl(),this.idleVideo().nativeElement.muted=!0,this.idleVideo().nativeElement.loop=!0,this.idleVideo().nativeElement.play().then())}static \u0275fac=(()=>{let n;return function(e){return(n||(n=te(i)))(e||i)}})();static \u0275cmp=ee({type:i,selectors:[["app-temp-avatar"]],viewQuery:function(t,e){t&1&&(T(e.baseElement,je,5),T(e.waves,Ne,5),T(e.video,Be,5),T(e.idleVideo,Ue,5),T(e.chatContainer,We,5)),t&2&&se(5)},hostVars:2,hostBindings:function(t,e){t&2&&re("block h-full w-full")},standalone:!0,features:[ne,le],decls:50,vars:41,consts:[["baseElement",""],["waves",""],["video",""],["idleVideo",""],["container",""],["linkRef",""],[1,"relative","h-full","w-full","flex","items-center","justify-center","bg-secondary-100","rounded-xl","shadow"],[1,"flex","flex-col","items-center","h-full","justify-center","absolute"],[1,"absolute","w-[90%]","z-10","bottom-1/2","left-1/2","-translate-x-1/2","bg-black/70","text-white","text-sm","rounded","px-2","py-1"],[1,"absolute","-start-20","top-1/2","-translate-y-1/2","!w-16","flex","flex-col","gap-2"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"pointerdown","disabled"],[3,"color","borderWidth","width"],[1,"relative","w-full"],["matTooltipPosition","before","appButton","","shape","pill",1,"!p-1","!absolute","top-1/2","-translate-y-1/2","opacity-0","transition-all","duration-300",3,"click","matTooltip","ngClass"],["fill","currentColor","xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24",1,"w-5","h-5"],["d","M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"],[1,"relative","w-full","!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click","disabled"],[1,"relative","size-6"],["alt","start",1,"w-full","h-full",3,"src"],["alt","start",1,"absolute","top-0","left-0","w-full","h-full","opacity-60",3,"src"],["alt","start",1,"size-6",3,"src"],[1,"!h-16","flex","flex-col","items-center","justify-center","bg-white","rounded-md","shadow","text-primary","text-xs","transition-all","hover:bg-white/70","disabled:opacity-50","disabled:cursor-not-allowed",3,"click"],["fill","currentColor","xmlns","http://www.w3.org/2000/svg","viewBox","0 0 24 24",1,"size-8"],["d","M5,5H10V7H7V10H5V5M14,5H19V10H17V7H14V5M17,14H19V19H14V17H17V14M10,17V19H5V14H7V17H10Z"],[1,"w-full","absolute","top-2","px-2","flex","justify-between","items-center"],[1,"relative","flex","items-center","gap-2","shadow-2xl","shadow-white","bg-black/20","py-1","px-2","rounded-full"],[1,"text-white","text-sm","font-semibold"],[1,"p-2","rounded-full",3,"ngClass"],[1,"p-2","absolute","end-2","pulse","rounded-full",3,"ngClass"],[1,"w-24","h-7","overflow-x-hidden","transition-all"],[1,"-translate-x-1","w-full","pointer-events-none","h-full","opacity-90",3,"ngClass"],["autoplay","",1,"h-full",3,"hidden"],[1,"h-full",3,"hidden"],["type","video/webm",3,"src"],[1,"absolute","bottom-0","w-full","max-h-[45%]","overflow-y-auto","no-scrollbar","overflow-x-hidden"],[1,"min-h-0","flex-auto","flex","flex-col","gap-1","w-full","h-full","relative","overflow-hidden","py-1","px-2","[&>.message.user]:justify-start","[&>.message]:text-white"],[3,"class"],[1,"size-6","text-primary",3,"innerHTML"],["appTextWriterAnimator","",1,"whitespace-pre-wrap","break-words",3,"text"],[1,"whitespace-pre-wrap","break-words",3,"innerHtml"],["appTextWriterAnimator","",1,"whitespace-pre-wrap","break-words",3,"animating","text"],[1,"icon-with-title",3,"click"],[1,"mdi",3,"ngClass"],[1,"title"],["hidden",""],["dir","auto"],[1,"d-inline"],[1,"px-1","text-primary"],[1,"mdi","mdi-link-variant"],[1,"d-inline","citation-link",2,"cursor","pointer"]],template:function(t,e){if(t&1){let o=V();a(0,"div",6,0)(2,"div",7),R(3,Ze,2,1,"span",8),a(4,"div",9)(5,"button",10),f("pointerdown",function(){return u(o),h(e.toggleStream())}),R(6,Je,1,3,"app-spinner-loader",11)(7,Ke,2,2),s(),a(8,"div",12)(9,"button",13),f("click",function(){return u(o),h(e.rejectText())}),F(),a(10,"svg",14),c(11,"path",15),s()(),j(),a(12,"button",16),f("click",function(){return u(o),h(e.toggleRecording())}),R(13,Xe,3,4)(14,et,3,2)(15,tt,3,2)(16,it,4,5),s()(),a(17,"button",17),f("click",function(){return u(o),h(e.interruptAvatar())}),a(18,"span",18),c(19,"img",19)(20,"img",20),s(),p(21),s(),a(22,"button",17),f("click",function(){return u(o),h(e.clearChat())}),c(23,"img",21),p(24),s(),a(25,"button",22),f("click",function(){return u(o),h(e.toggleFullScreen())}),F(),a(26,"svg",23),c(27,"path",24),s(),p(28),s()(),j(),a(29,"div",25)(30,"div",26)(31,"span",27),p(32),s(),c(33,"div",28)(34,"div",29),s(),a(35,"div",30),c(36,"div",31,1),s()(),c(38,"video",32,2),a(40,"video",33,3),c(42,"source",34),s(),a(43,"div",35)(44,"div",36,4),B(46,st,4,5,"div",37,qe),s()()(),p(48),Y(49,"async"),s()}t&2&&(r(3),v(e.recognizedText()?3:-1),r(2),l("disabled",e.store.isStreamLoading()),r(),v(e.store.isStreamLoading()?6:7),r(3),l("matTooltip",e.lang.locals.cancel_recording)("ngClass",q(29,Qe,e.store.isRecordingStarted())),r(3),l("disabled",e.store.isRecordingLoading()||e.recognizingStatus()),r(),v(e.store.isRecordingLoading()?13:-1),r(),v(e.store.isRecordingStopped()?14:-1),r(),v(e.store.isRecordingStarted()&&e.recognizingStatus()?15:-1),r(),v(e.store.isRecordingStarted()&&!e.recognizingStatus()?16:-1),r(),l("disabled",!e.store.isStreamStarted()),r(2),l("src","assets/icons/speak.png",_),r(),l("src","assets/icons/stop.png",_),r(),b(" ",e.lang.locals.stop_talking," "),r(),l("disabled",!e.chatService.messages().length),r(),l("src","assets/icons/clear-chat.png",_),r(),b(" ",e.lang.locals.clear_chat_history," "),r(4),b(" ",e.lang.locals.full_screen," "),r(4),C(e.onlineStatus()),r(),l("ngClass",Q(31,Oe,e.store.isStreamStopped(),e.store.isStreamStarted(),e.store.isStreamLoading())),r(),l("ngClass",Q(35,Oe,e.store.isStreamStopped(),e.store.isStreamStarted(),e.store.isStreamLoading())),r(),l("@recordButton",e.store.recording()),r(),l("ngClass",q(39,Ye,!e.store.isRecordingStarted())),r(2),l("hidden",e.store.isStreamStopped()||e.store.isStreamLoading()),r(2),l("hidden",e.store.isStreamStarted()),r(2),l("src",e.store.idleAvatarUrl(),_),r(4),U(e.chatService.messages()),r(2),b(" ",pe(49,27,e.init$),`
`))},dependencies:[ve,ue,he,ye,Le,Ee,Te,Se,ke,Ve],styles:['.message[_ngcontent-%COMP%]{position:relative;display:flex;flex-direction:column;font-size:.75rem;line-height:1rem}.message.user[_ngcontent-%COMP%]{align-items:flex-start}.message.user[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{border-radius:.375rem;border-top-right-radius:0;background-color:#00000080;padding:.125rem}.message.user[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:after{content:"";position:absolute;right:-8px;top:0;width:8px;height:8px;clip-path:polygon(0 0,100% 0,0 100%);background-color:inherit}.message.assistant[_ngcontent-%COMP%]{align-items:flex-end}.message.assistant[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{border-radius:.375rem;border-top-left-radius:0;background-color:#0003;padding:.125rem}.message.assistant[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:after{content:"";position:absolute;left:-8px;top:0;background-color:inherit;width:8px;height:8px;clip-path:polygon(0 0,100% 0,100% 100%)}'],data:{animation:[_e("recordButton",[M("InProgress",I({transform:"scale(1)",backgroundColor:"gray"})),M("Started",I({transform:"scale(1)"})),M("Stopped",I({transform:"scale(0)"})),we("* <=> *",[Ce("150ms ease-in-out")])])]}})};export{G as default};
