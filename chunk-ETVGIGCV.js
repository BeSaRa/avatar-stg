import{c as Y}from"./chunk-DEUCULCI.js";import{b as W}from"./chunk-LQAATZVK.js";import{a as G}from"./chunk-6BC4QFZY.js";import{b as h}from"./chunk-FEAJVVOQ.js";import{b as q}from"./chunk-JZHZ6J63.js";import{Ab as S,B as u,Dc as F,Fb as R,Gc as N,Hc as j,Ia as I,Ic as B,Jc as U,Kb as L,M as V,N as b,Nb as P,Ob as l,P as A,Ra as O,Tb as _,X as D,Yb as f,Yc as C,Zb as c,_b as g,ea as s,fa as v,ha as d,hc as $,i as E,jb as T,ld as H,ob as o,od as Q,qa as p,s as m,sc as y,tc as M,ua as z,vc as k,w as r,xc as x}from"./chunk-UVO63754.js";var K=["video"],X=["idleVideo"],Z=(a,i,e)=>({"h-full":a,"w-full":i,"overflow-hidden":e}),ee=(a,i)=>({"h-full":a,"w-full":i});function te(a,i){if(a&1&&(f(0,"video",5,1),g(2,"source",6),c()),a&2){let e=$();l("ngClass",N(3,ee,e.hasSize(),!e.hasSize()))("hidden",e.store.isStreamStarted()),o(2),l("src",e.store.idleAvatarUrl(),T)}}var J=class a extends G(class{}){size=O();hasSize=C(()=>!!this.size());fullWidth="w-full h-full block ";video=S.required("video");idleVideo=S("idleVideo");avatarService=p(Y);lang=p(q);start$=new m(1);stop$=new m(1);store=p(W);init$=this.start$.asObservable().pipe(d(()=>this.store.updateStreamStatus("InProgress"))).pipe(v(this.destroy$)).pipe(D(()=>this.avatarService.startStream(this.size()).pipe(A(i=>{throw this.store.updateStreamStatus("Stopped"),i})).pipe(h()))).pipe(s(i=>{let{data:{webrtcData:{offer:e,iceServers:t}}}=i;return this.pc=new RTCPeerConnection({iceServers:t,iceTransportPolicy:"relay"}),this.pc.addEventListener("icecandidate",n=>{n.candidate&&this.avatarService.sendCandidate(n.candidate).subscribe()}),this.pc.addEventListener("icegatheringstatechange",n=>{n.target.iceGatheringState=="complete"&&this.video().nativeElement.paused&&(this.video().nativeElement.play().then(),this.store.updateStreamStatus("Started"))}),this.pc.addEventListener("track",n=>{this.video().nativeElement.srcObject=n.streams[0]}),this.pc.addEventListener("connectionstatechange",n=>{let w=n.target.connectionState;w==="connected"&&this.store.updateStreamStatus("Started"),w==="disconnected"&&this.store.updateStreamStatus("Stopped")}),r(this.pc.setRemoteDescription(new RTCSessionDescription(e))).pipe(s(()=>r(this.pc.createAnswer()))).pipe(s(n=>r(this.pc.setLocalDescription(n)).pipe(u(()=>n)))).pipe(s(n=>this.avatarService.sendAnswer(n)))})).pipe(u(()=>""));onlineStatus=C(()=>{switch(this.lang.localChange(),this.store.streamingStatus()){case"Started":return this.lang.locals.connected;case"InProgress":return this.lang.locals.connecting;case"Disconnecting":return this.lang.locals.disconnecting;default:return this.lang.locals.not_connected}});ngOnInit(){return E(this,null,function*(){this.store.updateStreamStatus("Stopped"),V(this.destroy$).pipe(d(()=>this.store.updateStreamStatus("Stopped"))).pipe(s(()=>this.avatarService.closeStream().pipe(h()))).subscribe(()=>{console.log("COMPONENT DESTROYED")}),this.stop$.pipe(b(()=>this.store.hasStream())).pipe(d(()=>this.store.updateStreamStatus("Disconnecting"))).pipe(v(this.destroy$)).pipe(s(()=>this.avatarService.closeStream().pipe(h()))).subscribe(()=>{this.store.updateStreamStatus("Stopped"),console.log("MANUAL CLOSE"),this.store.updateStreamStatus("Stopped")}),this.size()||this.start$.next()})}ngAfterViewInit(){this.playIdle()}playIdle(){this.idleVideo()&&this.idleVideo()?.nativeElement&&(this.idleVideo().nativeElement.src=this.store.idleAvatarUrl(),this.idleVideo().nativeElement.muted=!0,this.idleVideo().nativeElement.loop=!0,this.idleVideo().nativeElement.play().then())}static \u0275fac=(()=>{let i;return function(t){return(i||(i=I(a)))(t||a)}})();static \u0275cmp=z({type:a,selectors:[["app-avatar-video"]],viewQuery:function(e,t){e&1&&(y(t.video,K,5),y(t.idleVideo,X,5)),e&2&&M(2)},hostVars:1,hostBindings:function(e,t){e&2&&P("class",t.fullWidth)},inputs:{size:[1,"size"]},standalone:!0,features:[R,F],decls:7,vars:10,consts:[["video",""],["idleVideo",""],["id","video-wrapper",1,"flex","items-center","w-full","h-full","justify-center"],[1,"flex","flex-col","items-center","w-full","h-full","justify-center","absolute"],["autoplay","",3,"hidden","ngClass"],[3,"ngClass","hidden"],["type","video/webm",3,"src"]],template:function(e,t){e&1&&(f(0,"div",2)(1,"div",3),g(2,"video",4,0),L(4,te,3,6,"video",5),c(),k(5),B(6,"async"),c()),e&2&&(o(2),l("hidden",t.store.isStreamStopped()||t.store.isStreamLoading())("ngClass",j(6,Z,t.hasSize(),!t.hasSize(),!t.hasSize())),o(2),_(t.hasSize()?4:-1),o(),x(" ",U(6,4,t.init$),`
`))},dependencies:[Q,H]})};export{J as a};
